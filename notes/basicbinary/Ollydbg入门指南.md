# OllyDbg入门指南

> 内容来自Michael Sikorski 著 《恶意代码分析实战》

OllyDbg是一种具有可视化界面的32位汇编分析调试器，是一个新的动态追踪工具，将IDA与SoftICE结合起来的思想，Ring3级调试器，非常容易上手，己代替SoftICE成为当今最为流行的调试解密工具了。同时还支持插件扩展功能，是目前最强大的调试工具。

OllyDbg 近二十年前就存在了，它被用来分析破解软件、分析恶意代码、开发漏洞利用程序等等。

Immunity Security公司买下了OllyDbg 1.1的基础代码，并将其改名为Immunity Debuger（ ImmDbg ），改变了它的外观，带有完整功能的Python 解释器API后，使ImmDbg被很多人使用。

OllyDbg和ImmDbg都是分析程序的好工具。

下面以OllyDbg201版本为例介绍。

## OllyDbg加载代码（可执行代码）

有多种加载方法：

1. 一种是点击菜单 文件->打开 （快捷键是 F3）来打开一个可执行文件进行调试；
2. 另一种是点击菜单 文件->附加 来附加到一个已运行的进程上进行调试。注意这里要附加的程序必须已运行。
3. 第三种就是用右键菜单来载入程序（不知这种算不算）。

一般情况下我们选第一种方式。比如我们选择一个 test.exe 来调试，通过菜单 文件->打开 来载入这个程序，OllyDBG 中显示的内容将会是这样（图1）：

![OllyDBG 界面](images\ollydbg\01.png)


如果要调试的程序需要参数，则在open对话框的Arguments输入框给出（只能在加载期间给OllyDbg传递参数）。

![OllyDBG 传入参数界面](images\ollydbg\02.png)

一旦能够打开某个exe文件，OllyDbg就会用加载器加载这个二进制程序。这种加载方法与Windows操作系统加载文件相似。

默认情况下，如果能够确定软件的入口位置，即WinMain，OllyDbg会在这个位置暂停程序的执行。例如图1中“黑色高亮”位置。否则，OllyDbg会在软件PE头部提供的入口点处中断。

另外，你也可以选择OllyDbg的Debugging Options菜单，来修改这些启动选项。例如，要在代码执行前立刻中断，选择System Breakpoint作为启动选项。

使用第2种方法调试也是很有用的方式，即使用菜单File-Attach，去附着在已打开的程序上。如下图所示：

![OllyDBG Attach](images\ollydbg\03.png)

OllyDbg附加某个进程后，进程当前执行线程的代码会被暂停，并显示在OllyDbg的窗口中。然而，有可能这个进程正在调用某个系统Dll，为了不去调试windows库，我们可以在整个代码段中设置一个断点，这样就可以让这个程序在下次访问代码段时中断执行。

## OllyDbg的接口

OllyDbg界面有四个信息窗口。

- 反汇编面板1
  显示了被调试程序的汇编代码，即当前指令指针前后的一些指令。通常，下一条要被执行的指令在这个窗口高亮显示，如果要修改指令或数据，可以在这个窗口中按空格键。


- 寄存器面板2
  显示被调试程序寄存器的当前状态。当前修改了的寄存器会从黑色变成红色。可以用右键Modify修改其中的值。


- 栈面板3
  用来显示被调试堆栈当前状态。可以选择Modify来操作这个栈。有些单元上会有注释，描述了一个API之前栈存放的参数。有助于分析。


- 内存转储面板4
  实时内存转储状况。在这个窗口按Ctrl+G，输入一个内存地址可以跳转到任何地址，也可以单击一个地址，然后选follow in dump，来转储那个内存地址。如果想要编辑这个内存地址中的值，右键点击选择Binary-Edit。

![OllyDBG 界面](images\ollydbg\04.png)

## 内存映射

点击菜单view-memory map，可以显示出被调试程序的所有内存块（程序在内存中的内容）。

![OllyDBG 界面](images\ollydbg\05.png)

内存映射是查看程序在内存中布局的好方式。上图中，同时标注了可执行程序的代码段和数据段，所有DLL程序以及他们的代码段、数据段都是可见的。

你可以双击内存映射的任意一行，显示那个段的内存转储。也可以通过一段内存转储，然后选择“View in Disassembler”的方式，将其中的数据发送到反汇编窗口。

### 基地址重定位

内存映射能够帮助我们理解一个PE文件在运行时如何被重定位。基地址重定位是指Windows中的一个模块没有被加载到其它预定基地址时发生的情况。