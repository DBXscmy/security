# 分析恶意Windows程序

非恶意程序总体上由编译器良好生成；恶意程序通常结构很差，并趋向于执行预期之外的动作。

## Windows API

Windows API是一个广泛的功能集合，管理着恶意代码与微软程序库之间的交互方式。

它使用特定的术语、名字、约定，需要我们熟悉。

### 类型和匈牙利表达法

多数Windows API使用它自己的名字，来表示C语言类型。举例说明：

- DWORD，表示32位无符号整数；
- WORD，表示16位无符号整数；

Windows总体上使用匈牙利表达法，作为API函数标识符。这个表达式使用一个前缀命名模式，来使识别一个变量的类型更为容易。包含一个32位无符号整数的变量，或DWDRD，会以dw开头。举例来说，如果VirtualAllocEx函数的第三个参数是dwSize，你就知道它是一个DWORD类型。

匈牙利表达法使识别变量类型和解析代码更容易，但它也能变得笨重。

![widows api](images/windowsmalwareanalyse/windowsapi.png)

### 句柄

句柄是在操作系统中被打开或被创建的项，比如一个窗口、进程、模块、菜单、文件，等等。

句柄在它们引用一个对象或其他某个内存位置这点上很像指针。然而，和指针不同的是，句柄不能被用来进行数学操作，并且它们不总是表示对象地址。你能对句柄做的唯一的事情，就是保存它，并在后续函数调用中使用它来引用同一个对象。

### 文件系统函数

恶意代码与系统交互的一个最常用的方式就是创建或修改文件，而且独特文件名或修改为既有的文件名是明显的基于主机的感染迹象。

文件活动可以提示这个恶意代码在做什么。例如，若恶意代码创建一个文件，并在那个文件中保存Web浏览习惯，这个程序可能就是某种形式的间谍软件。

微软提供了多个函数来访问文件系统：

- CreateFile

这个函数被用来创建和打开文件。它可以打开已经存在的文件，管道，流，以及I/O设备，还能创建新的文件。参数dwCreationDisposition控制CreateFile函数是否创建一个新的文件，或是打开一个己经存在的文件。

- Readfile
- WriteFile

上面两个函数被用来对文件进行读和写。两个都将文件作为流来操作。当你第一次调用ReadFile时，你从一个文件中读取后续一些字节;下次你调用它，你读取它后面的一些字节。例如，若你打开一个文件，并用40字节大小调用ReadFile，下次你再调用它，它将会从前40个字节之后处开始读。如
你所能想象的，这两个函数都不能在一个文件中灵活地跳转。

- CreateFileMapping
- MapViewOfFile

文件映射经常被恶意代码作者使用，因为它们允许将一个文件加载到内存中，以便更加容易地进行操作。

CreateFileMapping函数负责从磁盘上加载一个文件到内存中。

MapViewOfFile函数则返回一个指向映射的基地址指针，它可以被用来访问内存中的文件。

程序调用两个函数，能够使用从MapViewOfFile函数返回的指针，在文件中的任意位置进行读取和写入。

这个特性在解析一个文件格式时极其顺手，因为你可以简单地跳转到不同内存地址。

注意:文件映射被普遍用来复制Windows加载器的功能。在获得一个文件的映射以后，恶意代码可以解析PE头，并对内存中的文件进行所有需要的修改，因此使PE文件就像被操作系
统加载器加载一样执行起来。

### 特殊文件

Windows系统中有一些特殊的文件类型，它们的访问方式与普通文件不太一样，但是它们不能通过它们的盘符与文件夹(比如c:\dots)进行访问。恶意程序经常使用特殊文件。

有些特殊文件要比普通文件更隐蔽，因为它们在列目录时不会显示出来。某些特殊文件可以提供对系统硬件和内部数据更强的访问能力。

特殊文件可以作为字符串参数被传递给任何文件操作函数中，并像普通文件一样进行操作。在这里，我们来介绍一下共享文件、可通过名字空间访问的文件和备用数据流。

#### 共享文件

共享文件是以(\\\serverNamelshare或\\\?\\\serverNamelshare开头命名的特殊文件。它们用来访问保存在共享目录中的目录或文件。"\\\ ? \\"前缀告诉操作系统禁用所有的字符串解析，并允许访问长文件名。

#### 通过名字空间访问的文件
    
在操作系统中，还有一些文件可以通过名字空间进行访问。名字空间可以被认为是固定数目的文件夹，每一个文件夹中保存不同类型的对象。底层的名字空间是NT名字空间，以前缀\开始。

NT名字空间可以访问所有设备，以及所有在NT名字空间中存在的其他名字空间。


注意:要浏览你系统上的NT名字空间，可以使用从微软那里免费获得的WinObj对象管理器名字空间查看器。

以前缀```\\.\```开始的Win32设备名字空间，经常被恶意代码用来直接访问物理设备，并且像一个文件一样进行读写操作。

例如，一个程序可能使用```\\.\PhysicalDisk1```来直接访问PhysicalDisk1，而忽略它的文件系统，因此这允许程序通过普通API不可能做到的方式来修改磁盘。使用这个方法，恶意代码可以读写数据到一个未分配的扇区，而无须创建或访问文件，这允许它避开防病毒与安全程序的检测。

例如，几年前的Witty蠕虫通过NT命名空间访问```\Device\PhysicalDiskl```，使受害者的文件系统崩溃。它可以打开```\Device\PhysicalDiskl```，并间歇性地写数据到驱动器上的随机空间中，最终使受害者的操
作系统崩溃并无法引导。这个蠕虫持续时间不长，因为受害者的系统在这个蠕虫能够传播之前就经常发生故障了，但它对被它感染的系统造成了不小的损失。

另一个例子是恶意代码使用```\Device\PhysicalMemory```来直接访问物理内存，这允许用户空间程序写到内核空间中。这个技术己经被恶意代码用来修改内核，并隐藏用户空间的程序。

注意:从Windows 2003 SP1开始，```\Device\PhysicalMemory```从用户空间已经无法访问。然而，你仍然可以从内核空间访问到 ```\Device\PhysicalMemory```，这可以被用来访问诸如BIOS代码和配置的底层信息。


#### 备用数据流
    
备用数据流(ADS)特性允许附加数据被添加到一个己存在的NTFS文件中，相当于添加一个文件到另外一文件中。

额外数据在列一个目录时不会被显示出来，并且当显示文件内容时也不显示; 而只有在你访问流时，它才是可见的。

ADS数据流根据约定normalFile.txt: Stream: $DATA来命名，这允许一个程序去读写一个流。恶意代码作者喜欢ADS，因为它能被用来隐藏数据。

## Windows 注册表

