# 动态分析技术基础

动态分析就是在运行恶意代码之后进行检查的过程。一般在静态分析不能解决问题时使用。例如，程序进行了混淆或无法理解程序时。

## 沙箱

比较简单的动态分析技术之一，是使用沙箱。

沙箱是一种在安全环境里运行不可信程序的安全机制，即一个虚拟环境，模拟网络和系统服务，使得被测试的软件可以正常运行。

有许多分析恶意代码的沙箱（前两个比较常用）：

- Norman沙箱
- GFI沙箱
- Anubis
- Joe沙箱
- ThreatExpert
- BitBlaze
- Comdo等

虽然沙箱为我们提供了虚拟安全环境，但是恶意程序可以检测出沙箱环境的存在，从而不激活特定功能，这样沙箱中的动态分析就失去意义了。

此外，沙箱的能力是有限的，只能做基础的动态分析检查。

## 运行恶意代码

如果不运行恶意程序，动态分析基础技术就意义不大。运行一个EXE式的恶意代码很容易，但运行一个DLL式的恶意代码就不容易了。

如果启动一个DLL文件？

### 使用rundll32.exe

所有Windows中都包含了rundll32.exe程序，它提供了运行DLL的平台，用下面命令格式可以加载DLL：

```
c:\>rundll32.exe DLLname , Export arguments(参数)
```

Export值必须是一个DLL文件导出表中的函数名或者序号。可以使用Dependency Walker查看导出函数表。

例如，文件sqlite3.dll有如下导出表：

![导出函数列表](images\动态分析\导出函数列表.png)

如果像运行 sqlite_db_status 函数，有两种方法：

```
c:\>rundll32.exe  sqlite3.dll, sqlite_db_status
```
或使用序号

```
c:\>rundll32.exe  sqlite3.dll, #64
```

恶意的DLL文件通常在DLLMain（称作DLL函数入口点）执行它们的代码，因为无论DLL什么时候被加载，DLLMain函数总会被执行，这样就总能通过rundll32.exe加载DLL，而动态地获取信息。

### 修改PE头部

除此之外，你甚至可以通过修改PE头部，改变它的扩展名，使得windows以一种可执行文件的方式来加载DLL。我们可以使用如下方法来修改PE头部，即从IMAGE_FILE_HEADER的特征域里擦除IMAGE_FILE_DLL(0x2000)标记。

尽管这样的修改不会执行任何输入函数，但他会调用DLLMain方法，而且有可能造成恶意代码意想不到的崩溃或者终止。然而，只要修改使恶意代码执行它的恶意部分，你就能收集到信息，这有时就足够了。

### 将DLL安装为一个服务

如果，DLL形态的恶意代码需要被安装为一个服务，那么可以用如下命令安装：

```
c:\> rundll32.ex3 ipr32x.dll , InstallService ServiceName

c:\> net start ServiceName
```

这里的ServiceName参数必须提供给恶意代码，让她能被安装运行起来。而在windows系统中启动指定的服务可用net start命令。

注意，如果你在可疑代码中看见一个ServiceMain函数，没有像Install或InstallService这样的导出函数，那你需要手动安装服务。可以使用windows系统下的sc命令，或者修改注册表为一个未使用服务进行手动安装，然后使用net start启动服务。Windows服务的注册表项位于HKLM\SYSTEM\CurrentControlSet\Services.

## 进程监视器

进程监视器（process monitor）是Windows系统下的高级监视工具，它可以监控注册表、文件系统、网络、进程、线程行为。

它结合了两种工具：

- 文件监视器FileMon
- 注册表监视器RegMon

它不能完成以下任务：

- 监控网络行为
- 用户态组件通过设备IO控制与内核套件进行通信的设备驱动行为；
- 一些特定的图形界面调用，如SetWindowsHookEx等。

一旦启用这个工具，他就会开始监测，每秒钟会有上万个事件被捕捉，这可能会耗尽内存。所以，在监控一段时间后就要Edit-capture来抓取当前已检测到的进程（停止监测）。

监视前，要选择Edit-Clear Display清除掉不相关的数据。

![processmonitor1](images/动态分析/processmonitor1.png)

要找到信息，往往需要过滤器（Filter-filter)进行过滤。过滤器设置后，仅影响显示，不影响监测过程。

## 进程浏览器（process explorer）查看进程

这个工具是微软提供的，它是一个强大的任务管理器，是进行动态分析时必备的工具。

可以使用它来列出所有活跃的进程、被进程载入的DLL、各种进程属性和整体系统信息。

也可以使用它杀死一个进程、退出用户登录、启动和激活进程。

![processexplorer1](images/动态分析/processexplorer1.png)

进程浏览器上显示了5栏信息：

- Process进程名
- PID进程号
- CPU使用率
- Description描述
- Company Name软件公司名

视图每秒更新一次，其着色规则默认为：
- 服务以粉色高亮显示；
- 进程以蓝色显示；
- 新进程以绿色显示；
- 被终止的进程以红色显示。

双击一个进程，会打开一个属性窗口：

![processexplorer2](images/动态分析/processexplorer2.png)


### 使用验证（verify）功能

微软自己的程序都有数字签名，使用验证功能能够发现假冒的程序。这一功能在磁盘上windows文件没有被破坏时特别有用，恶意程序经常替换windows认证文件，使其签名合法，隐藏自己。

验证功能验证的是磁盘上的镜像文件，而不是内存中的，因此他可能会失败。如果一个攻击者使用进程替换技术process replacement，包括在系统上执行进程并用恶意代码重写内存空间，这时候验证功能就没有用了。

> 进程替换技术使得恶意代码和合法代码一样，具有同样的特权和签名，但他在内存中的镜像和磁盘上的不一样。

![processexplorer-verify](images/动态分析/processexplorer-verify.png)