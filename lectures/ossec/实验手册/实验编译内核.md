
# 实验  配置和编译 Linux kernel 

## 实验目的

1.掌握配置和编译 Linux 内核的基本方法

## 实验内容

1.下载、解压linux 内核

2.配置 linux 内核

3.编译 linux 内核

## 实验前提

请先克隆 ubuntu server 1604 虚拟机，并使用克隆虚拟机安装新kernel，以防原ubuntu linux 失效。

## 实验步骤

1.查找并且下载一份内核源代码

Linux受GNU通用公共许可证（GPL）保护，其内核源代码是完全开放的。现在很多Linux的网站都提供内核代码的下载。

推荐使用Linux的官方网站：http://www.kernel.org 。在这里你可以找到所有的内核版本。

考虑到下载需要时间，我们已将 Linux 5.3.1 kernel 下载到 ubuntu server 1604 虚拟机的 ~/Downloads/ 中。

2.运行下列命令解压kernel包。
```
leo@ubuntu:~# cd Downloads/
leo@ubuntu:~/Downloads$ tar -xvf linux-5.2.11.tar.xz 

```

3.第一次编译，有必要将内核源代码树置于一种完整和一致的状态。因此推荐执行命令:
```
leo@ubuntu:~/Downloads$ cd linux-5.2.11
leo@ubuntu:~/Downloads/linux-5.2.11$ make mrproper
```
它将清除目录下所有配置文件和先前生成核心时产生的.o文件。

如果出现下列情况,则按‘y’。
```
# cp configs/kernel-2.6.15-i686.config  .config

cp：overwrite ‘.config’ ?  y
```

4.配置（选择）内核，运行下列命令：
```
leo@ubuntu:~/Downloads/linux-5.2.11$ make menuconfig
```
make menuconfig 是基于文本的选单式配置界面。

进行配置时，大部分选项可以使用其缺省值，只有小部分需要根据用户不同的需要选择。

例如，如果硬盘分区采用ext2文件系统（或ext3文件系统），则配置项应支持ext2文件系统（ext3文件系统）。又例如，系统如果配有SCSI总线及设备，需要在配置中选择SCSI卡的支持。

5.配置完成后，选择Save配置，然后Exit。

在这一步会产生一个配置文件，默认名为：```.config```。

6.编译已配置内核，运行下列命令:
```
# 安装编译工具
leo@ubuntu:~/Downloads/linux-5.2.11$ sudo apt-get install libssl-dev bc  libelf-dev
# 编译
leo@ubuntu:~/Downloads/linux-5.2.11$ make

```
 
编译内核需要较长的时间，具体与机器的硬件条件及内核的配置等因素有关（几十分钟 ~ 数小时）。

完成后产生的内核文件bzImage的位置在 ```.../arch/i386/boot```目录下。这里假设用户的CPU是Intel x86。

如果你在配置时（第4步中）选择了可加载模块，编译完内核后，要对选择的模块进行编译。用下面的命令编译模块并安装到标准的模块目录中：
```
leo@ubuntu:~/Downloads/linux-5.2.11$ make modules

leo@ubuntu:~/Downloads/linux-5.2.11$ make modules_install
```
 
7.启动新的Linux内核

通常，Linux在系统引导后从/boot目录下读取内核映像到内存中。因此如果想要使用自己编译的内核，就必须先将启动文件安装到/boot目录下。使用命令:
```
leo@ubuntu:~/Downloads/linux-5.2.11$ cp -R ./arch/i386/boot/*.* /boot

leo@ubuntu:~/Downloads/linux-5.2.11$  make install
```
 

## 实验思考

浏览/boot目录，你一定发现了System.map-*_FC5文件，以及initrd-*_FC5.img文件。如果打开/boot/grub目录下面的grub.conf文件，不难发现命令：

initrd /boot/initrd-2.6.15-1.2054_FC5.img

这两个文件分别起什么作用？你能否设计一个实验来验证你的判断？

 

撰写实验报告的要求
按照实验报告模板格式撰写；
整个实验过程的解图；
编译内核成功后，您计算机上grub.conf（或grub.cfg）文件的内容；
实验过程中遇到的问题及解决方法等；


http://jpkc.scezju.com/czxtyl/redir.php?catalog_id=105545

https://zhuanlan.zhihu.com/p/31342840

https://github.com/shaonianruntu/OS-lab