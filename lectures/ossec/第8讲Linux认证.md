# 第8讲 Linux的本地认证

本讲将讨论如下问题：
- 用户认证和登录
- 限制用户的登录能力
- 使用acct监视用户行为
- 使用USB设备和PAM的登录认证
- 定义用户授权控制

## 用户认证和登录

用户认证的一个主要功能就是监视系统的用户。

有很多种方法跟踪了解那些试图登录（无论成功或失败）Linux系统的用户的情况。

**Linux系统维护着一个记录所有来自不同账户的登录尝试的日志文件。这些日志文件存放在/var/log/、/etc/log/等目录下。**

### 查看账户登录信息

#### 查看登录信息

如果想查看最近的某用户账户的登录信息，可以使用last命令。last工具将/etc/log/wtmp文件按照某种格式显示出来。
```last```
语法：
```last [-adRx][-f ][-n ][帐号名称...][终端机编号...]```

参数说明：
- -a，把从何处登入系统的主机名称或IP地址，显示在最后一行。
- -d，将IP地址转换成主机名称。
- -f <记录文件>，指定记录文件，默认是显示/var/log目录下的wtmp文件的记录，但/var/log目录下得btmp能显示的内容更丰富，可以显示远程登录，例如ssh登录 ，包括失败的登录请求。
- -n <显示列数>或-<显示列数>，设置列出名单的显示列数。
- -R，不显示登入系统的主机名称或IP地址。
- -x，显示系统关机，重新开机，以及执行等级的改变等信息。
- -i， 显示特定ip登录的情况
- -t，  显示YYYYMMDDHHMMSS之前的信息

结果格式：
```条目格式 用户名 终端位置 登录ip或者内核 开始时间 结束时间 持续时间 ```

其中，结束时间内容可以为：
- still login in 还未退出  
- down 直到正常关机 
- crash 直到强制关机 


last命令的数据源： 
- /var/log/wtmp，默认数据源，记录每个用户的登录次数和持续时间等信息。
- /var/log/btmp，默认详细信息，包括登录失败请求
- 数据源格式：二进制（可以通过dump-utmp 命令进行阅读）


#### 查看某用户账户的错误登录信息

若要查看某些试图以错误密码登陆账户的信息，可以使用```lastb```命令。

例1：查看root账户可以使用如下命令：```sudo lastb root```

例2：查看leo账户可以使用如下命令：```sudo lastb leo```


### 查看内存中缓存的Linux内核信息

dmesg命令显示linux内核的环形缓冲区信息，我们可以从中获得多个运行级别的大量的系统信息。诸如：
- 系统架构
- cpu
- 挂载的硬件
- RAM等

dmesg命令设备故障的诊断是非常重要的。在‘dmesg’命令的帮助下进行硬件的连接或断开连接操作时，我们可以看到硬件的检测或者断开连接的信息。



#### 列出加载到内核中的所有驱动

可以使用下列命令查看所有驱动：
```dmesg | more```

#### 列出所有被检测到的硬件

例如：要显示所有被内核检测到的硬盘设备，可以使用下列命令查看所有被检测到的硬件：
```dmesg | grep sda```

又例如：查看内核信息，仅显示和USB设备有关的日志信息,可以使用下列命令：
```dmesg |grep usb```

#### 只输出dmesg命令的前20行日志

在‘dmesg’命令后跟随‘head’命令来显示开始几行，‘dmesg | head -20′命令将显示开始的前20行。
``` dmesg | head  -20```

#### 只输出dmesg命令最后20行日志

在‘dmesg’命令后跟随‘tail’命令（‘ dmesg | tail -20’）来输出‘dmesg’命令的最后20行日志，当你插入可移动设备时它是非常有用的。
```dmesg | tail  -20```

#### 搜索包含特定字符串的被检测到的硬件

由于‘dmesg’命令的输出实在太长了，在其中搜索某个特定的字符串是非常困难的。因此，有必要过滤出一些包含‘usb’ ‘dma’ ‘tty’ ‘memory’等字符串的日志行。grep 命令 的‘-i’选项表示忽略大小写。
```
dmesg | grep -i usb
dmesg | grep -i dma
dmesg | grep -i tty
dmesg | grep -i memory

```
#### 清空dmesg缓冲区日志

我们可以使用如下命令来清空dmesg的日志。该命令会清空dmesg环形缓冲区中的日志。但是你依然可以查看存储在‘/var/log/dmesg’文件中的日志。你连接任何的设备都会产生dmesg日志输出。
```dmesg -c```

### 查看授权信息

授权信息存放在/var/log/auth.log中。

例如：查看10条距当前时间最近的授权日志信息，可以使用如下命令：
```sudo tail -n 10 /var/log/auth.log```

在上面的命令中，“-n”选项指明显示日志信息的行数（上例中为10）。