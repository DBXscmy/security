# 密码破解

## 密码破解方法论

### 破解原则

破解时采取先易后难的原则，建议如下：

- 利用收集的公开字典进行破解

- 使用1-8位数字进行破解。

- 使用1-8位小写字母进行破解

- 使用1-8位大写字母进行破解

- 使用1-8位混合大小写+数字+特殊字符进行破解

### 实用建议

- 首先试试常用的弱口令字典
- 组合密码，如：zhang1999，用姓氏和出生年组合
- 把常用的掩码组合整理起来放在masks中的.hcmask文件中，然后让它自动加载破解
- 如果实在不行，你可以尝试低位数的所有组合去跑，不建议太高位数的组合去破解，若密码很复杂则花费更多时间也不行。
  
## 使用 HashCat 破解/恢复密码

hashcat号称世界上最快的密码破解工具。

特性：
- 世界上第一个和唯一的基于GPGPU规则引擎；
- 支持使用GPU、CPU、APU、DSP、FPGA、Coprocessor来进行密码破解；
- 免费支持多GPU（高达128个GPU）；
- 支持多哈希算法
- 支持多操作系统（Linux和Windows本地二进制文件）
- 支持多平台（OpenCL和CUDA支持）
- 支持多加密算法（目前247类）
- 资源利用率低
- 破解方法全面：基于字典攻击，暴力珀耳疾，融合方法；
- 支持分布式破解等等

> Hashcat支持的GPU需要查看详细文档。
> 
### 使用方法（Usage）

hashcat [options]… hash|hashfile|hccapxfile [dictionary|mask|directory]…

例如：

```
Todo...
```
### kali中的设置
 运行下列命令，查看使用条件是否满足：
 ```
root@kali2018:/usr/share/doc/hashcat-data/examples# hashcat -I
hashcat (v4.2.1) starting...

* Device #1: This device's constant buffer size is too small.

* Device #1: This device's local mem size is too small.

No devices found/left.

root@kali2018:/usr/share/doc/hashcat-data/examples# 

 ```
 如果你的环境下也出现上述问题，则说明暂不满足使用条件。

 需要做如下配置：

 

### 常见选项（options）

- -a  
指定要使用的破解模式，其值参考后面对参数。“-a 0”字典攻击，“-a 1” 组合攻击；“-a 3”掩码攻击。
- -m  
指定要破解的hash类型，如果不指定类型，则默认是MD5。
- -o  
指定破解成功后的hash及所对应的明文密码的存放位置,可以用它把破解成功的hash写到指定的文件中。
- --outfile-format 
指定破解结果的输出格式id,默认是3。
- --force 
忽略破解过程中的警告信息,跑单条hash可能需要加上此选项。
- --show  
显示已经破解的hash及该hash所对应的明文。
- --increment  
启用增量破解模式,你可以利用此模式让hashcat在指定的密码长度范围内执行破解过程。
- --increment-min  
密码最小长度,后面直接等于一个整数即可,配置increment模式一起使用。
- --increment-max  
密码最大长度,同上。

- --username   
忽略hash文件中的指定的用户名,在破解linux系统用户密码hash可能会用到。
- --remove     
删除已被破解成功的hash。
- -r       
使用自定义破解规则。

更多选项/参数使用下列命令获取：
```
hashcat --help
```

### hashcat 的口令破解模式

即-a 选项后可选用的内容。


- 0，即Straight（字段破解）
- 1，即Combination（组合破解）
- 3，即Brute-force（掩码暴力破解）
- 6，即Hybrid Wordlist + Mask（字典+掩码破解）
- 7，即Hybrid Mask + Wordlist（掩码+字典破解）

### Hash mode 对照表

即选项-m  后可以选用的内容。

Hash mode（id）对照表内容非常多，使用hashcat --help可以看到，这里列举部分。

|编号|mode|类型（category)|
|-|-|-|
| 900 | MD4| Raw Hash|
| 0 | MD5| Raw Hash|
|  5100 | Half MD5| Raw Hash|
| 100 | SHA1    | Raw Hash|
| 1300 | SHA2-224| Raw Hash|
| 1400 | SHA2-256| Raw Hash|
| 10800 | SHA2-384| Raw Hash|
| 1700 | SHA2-512| Raw Hash|
| 17300 | SHA3-224| Raw Hash|
| 17400 | SHA3-256| Raw Hash|
| 17500 | SHA3-384| Raw Hash|
| 17600 | SHA3-512| Raw Hash|
| 10 | md5($pass.$salt)|                            | Raw Hash, Salted and/or Iterated
| 20 | md5($salt.$pass)|  


### 输出格式

即选项--outfile-format  后可以选用的内容。

1 = hash[:salt]
2 = plain
3 = hash[:salt]:plain
4 = hex_plain
5 = hash[:salt]:hex_plain
6 = plain:hex_plain
7 = hash[:salt]:plain:hex_plain
8 = crackpos
9 = hash[:salt]:crackpos
10 = plain:crackpos
11 = hash[:salt]:plain:crackpos
12 = hex_plain:crackpos
13 = hash[:salt]:hex_plain:crackpos
14 = plain:hex_plain:crackpos
15 = hash[:salt]:plain:hex_plain:crackpos

### 掩码（mask）设置

掩码的作用就像正则表达式，按一定规则代表一组文本。

|掩码| 可表达字符|说明|
|-|-|-|
| l | abcdefghijklmnopqrstuvwxyz|  纯小写字母|
| u | ABCDEFGHIJKLMNOPQRSTUVWXYZ |  纯大写字母|
| d | 0123456789| 纯数字|
| h | 0123456789abcdef| 常见小写子目录和数字|
| H | 0123456789ABCDEF| 常见大写字母和数字|
| s |  !"#$%&'()*+,-./:;<=>?@[\]^_`{\|}~ | 特殊字符|
| a | ?l?u?d?s| 键盘上所有可见的字符|
| b | 0x00 - 0xff| 可能是用来匹配像空格这种密码的 |

举几个简单的例子来了解一下掩码的设置：
```
八位数字密码：?d?d?d?d?d?d?d?d
八位未知密码：?a?a?a?a?a?a?a?a
前四位为大写字母，后面四位为数字：?u?u?u?u?d?d?d?d
前四位为数字或者是小写字母，后四位为大写字母或者数字：?h?h?h?h?H?H?H?H
前三个字符未知，中间为admin，后三位未知：?a?a?aadmin?a?a?a
6-8位数字密码：--increment --increment-min 6 --increment-max 8 ?l?l?l?l?l?l?l?l
6-8位数字+小写字母密码：--increment --increment-min 6 --increment-max 8 ?h?h?h?h?h?h?h?h
```

如果我们想设置字符集为：abcd123456!@-+，那该怎么做呢。这就需要用到自定义字符集这个参数了，hashcat支持用户最多定义4组字符集。

```
--custom-charset1 [chars]等价于 -1
--custom-charset2 [chars]等价于 -2
--custom-charset3 [chars]等价于 -3
--custom-charset4 [chars]等价于 -4
在掩码中用?1、?2、?3、?4来表示。
```

再来举几个例子：

```
--custom-charset1 abcd123456!@-+。然后我们就可以用"?1"去表示这个字符集了
--custom-charset2 ?l?d，这里和?2就等价于?h
-1 ?d?l?u，?1就表示数字+小写字母+大写字母
-3 abcdef -4 123456 那么?3?3?3?3?4?4?4?4就表示为前四位可能是“abcdef”，后四位可能是“123456”
```

### 基于掩码（规则）的hash破解实例

#### 破解 7位数字组成的 hash值

```
hashcat -a 3 -m 0 --force 25c3e88f81b4853f2a8faacad4c871b6 ?d?d?d?d?d?d?d

```

#### 破解 7位小写字母 hash值

```
hashcat -a 3 -m 0 --force 7a47c6db227df60a6d67245d7d8063f3 ?l?l?l?l?l?l?l
```

#### 破解 1-8位数字 hash值

```
hashcat64.exe -a 3 -m 0 --force 4488cec2aea535179e085367d8a17d75 --increment --increment-min 1 --increment-max 8 ?d?d?d?d?d?d?d?d
```

#### 破解 1-8位小写字母+数字 hash值

```
hashcat64.exe -a 3 -m 0 --force ab65d749cba1656ca11dfa1cc2383102 --increment --increment-min 1 --increment-max 8 ?h?h?h?h?h?h?h?h
```

#### 破解 特定字符集：123456abcdf!@+- hash值

```
hashcat64.exe -a 3 -1 123456abcdf!@+- 8b78ba5089b11326290bc15cf0b9a07d ?1?1?1?1?1
注意一下：这里的-1和?1是数字1，不是字母l
```

#### 破解 1-8为位符集:123456abcdf!@+- hash值

```
hashcat64.exe -a 3 -1 123456abcdf!@+- 9054fa315ce16f7f0955b4af06d1aa1b --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1
```

#### 1-8位数字+大小写字母+可见特殊符号

```
hashcat64.exe -a 3 -1 ?d?u?l?s d37fc9ee39dd45a7717e3e3e9415f65d --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1
或者：
hashcat64.exe -a 3 d37fc9ee39dd45a7717e3e3e9415f65d --increment --increment-min 1 --increment-max 8 ?a?a?a?a?a?a?a?a
```

### 基于字典的hash破解实例

```
-a 0是指定字典破解模式，-o是输出结果到文件中
hashcat64.exe -a 0 ede900ac1424436b55dc3c9f20cb97a8 password.txt -o result.txt
```

字典组合破解

```
hashcat64.exe -a 1 25f9e794323b453885f5181f1b624d0b pwd1.txt pwd2.txt
```

字典+掩码破解
```
hashcat64.exe -a 6 9dc9d5ed5031367d42543763423c24ee password.txt ?l?l?l?l?l
```
### 批量破解hash实例

```
hashcat64.exe -a 0 hash.txt password.txt -o result.txt
```

### 破解mysql生成的hash码

Mysql4.1/5的PASSWORD函数可以生成某个字符串的hash码，有的项目使用hash码作为密文。

```
hashcat64.exe -a 3 -m 300 --force 6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 ?d?d?d?d?d?d
```

### sha512crypt $6$, SHA512 (Unix)破解

可以cat /etc/shadow获取.
```
hashcat64.exe -a 3 -m 1800 --force $6$mxuA5cdy$XZRk0CvnPFqOgVopqiPEFAFK72SogKVwwwp7gWaUOb7b6tVwfCpcSUsCEk64ktLLYmzyew/xd0O0hPG/yrm2X. ?l?l?l?l
```

不用整理用户名，使用--username

```
hashcat64.exe -a 3 -m 1800 --force qiyou:$6$QDq75ki3$jsKm7qTDHz/xBob0kF1Lp170Cgg0i5Tslf3JW/sm9k9Q916mBTyilU3PoOsbRdxV8TAmzvdgNjrCuhfg3jKMY1 ?l?l?l?l?l --username
```

### Windows NT-hash，LM-hash破解

可以用saminside获取NT-hash,LM-hash的值
```
# NT-hash:
hashcat64.exe -a 3 -m 1000 209C6174DA490CAEB422F3FA5A7AE634 ?l?l?l?l?l

# LM-hash:
hashcat64.exe -a 3 -m 3000 F0D412BD764FFE81AAD3B435B51404EE ?l?l?l?l?l
```

### wordpress密码hash破解

具体加密脚本在./wp-includes/class-phpass.php的HashPassword函数.

```
hashcat64.exe -a 3 -m 400 --force $P$BYEYcHEj3vDhV1lwGBv6rpxurKOEWY/ ?d?d?d?d?d?d
```

### discuz用户密码hash破解

其密码加密方式md5(md5($pass).$salt)

```
hashcat64.exe -a 3 -m 2611 --force 14e1b600b1fd579f47433b88e8d85291: ?d?d?d?d?d?d
```

### 破解RAR压缩密码

```
# 获取rar文件的hash值：rar2john.exe 1.rar
# 结果：
# 1.rar:$rar5$16$639e9ce8344c680da12e8bdd4346a6a3$15$a2b056a21a9836d8d48c2844d171b73d$8$04a52d2224ad082e

hashcat64.exe -a 3 -m 13000 --force $rar5$16$639e9ce8344c680da12e8bdd4346a6a3$15$a2b056a21a9836d8d48c2844d171b73d$8$04a52d2224ad082e ?d?d?d?d?d?d
```

hashcat 支持 RAR3-hp 和 RAR5，官方示例如下：

```
-m参数    类型      示例 hash
12500    RAR3-hp    $RAR3$*0*45109af8ab5f297a*adbf6c5385d7a40373e8f77d7b89d317
13000    RAR5       $rar5$16$74575567518807622265582327032280$15$f8b4064de34ac02ecabfe
```

### zip密码破解

```
# 用zip2john获取文件的hash值：zip2john.exe 1.zip
# 结果：
# 1.zip:$zip2$*0*3*0*554bb43ff71cb0cac76326f292119dfd*ff23*5*24b28885ee*d4fe362bb1e91319ab53*$/zip2$:::::1.zip-1.txt

hashcat64.exe -a 3 -m 13600 $zip2$*0*3*0*554bb43ff71cb0cac76326f292119dfd*ff23*5*24b28885ee*d4fe362bb1e91319ab53*$/zip2$ --force ?d?d?d?d?d?d

```
### 破解office密码

```
# 获取office的hash值：python office2john.py 11.docx
# 结果：# 11.docx:$office$*2013*100000*256*16*e4a3eb62e8d3576f861f9eded75e0525*9eeb35f0849a7800d48113440b4bbb9c*577f8d8b2e1c5f60fed76e62327b38d28f25230f6c7dfd66588d9ca8097aabb9

hashcat64.exe -a 3 -m 9600 $office$*2013*100000*256*16*e4a3eb62e8d3576f861f9eded75e0525*9eeb35f0849a7800d48113440b4bbb9c*577f8d8b2e1c5f60fed76e62327b38d28f25230f6c7dfd66588d9ca8097aabb9 --force ?d?d?d?d?d?d

```

### 破解WIFI密码

首先先把我们的握手包转化为hccapx格式，现在最新版的hashcat只支持hccapx格式了，以前的hccap格式已经不支持了.
官方在线转化https://hashcat.net/cap2hccapx/

```
hashcat64.exe -a 3 -m 2500 1.hccapx 1391040?d?d?d?d
```

### 其它

- 对于破解过的hash值，用hashcat64.exe hash --show查看结果
- 所有的hash破解结果都在hashcat.potfile文件中
- 如果破解的时间太长，可以按s键可以查看破解的状态，p键暂停，r键继续破解，q键退出破解。
- 在使用GPU模式进行破解时，可以使用-O参数自动进行优化

### hashcat 性能调优

考虑到hashcat的破解速度以及资源的分配，我们可以对一些参数进行配置

1. Workload tuning 负载调优。
该参数支持的值有1,8,40,80,160
--gpu-accel 160 可以让GPU发挥最大性能。

1. Gpu loops 负载微调
该参数支持的值的范围是8-1024（有些算法只支持到1000）。
--gpu-loops 1024 可以让GPU发挥最大性能。

3. Segment size 字典缓存大小
该参数是设置内存缓存的大小，作用是将字典放入内存缓存以加快字典破解速度，默认为32MB，可以根据自身内存情况进行设置，当然是越大越块了。
--segment-size 512 可以提高大字典破解的速度。
