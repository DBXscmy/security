# PE文件与虚拟内存之间的映射

文件偏移地址(File Offset)：数据在PE文件中的地址叫做文件偏移地址,可以理解为就是文件地址。这是文件在磁盘上存放相对与磁盘文件开头的偏移。

装载基址(Image Base):PE装入内存时的基地址。默认情况下，EXE文件在内存中对应的地址是0x00400000,DLL文件是0x10000000。这些位置可能通过编译选项修改。


虚拟内存地址(Virtual Address,VA )，是PE文件中的指令装入内存后的地址。

相对虚拟地址(Relative Virtual Address, RVA)，相对虚拟地址是内存地址相对于映射基址的偏移量。


虚拟内存地址，映射地址，相对虚拟内存地址三者之间:

> VA = Image Base + RVA

文件偏移地址是相对于文件开始处0字节的偏移,RVA(相对虚拟地址)则是相对于装载基址0x00400000处的偏移.由于操作系统在装载时“基本”上保持PE中的数据结构，所以文件偏移地址和RVA有很大的一致性。（不是全部相同）

PE文件中的数据按照磁盘数据标准存放，以0x200直接位基本单位进行组织。当一个数据节(stction)不足0x200字节时，不足的地方将用0x00填充，下一个数据节超过0x200时，下一个0x200将分配给这个字节实用。所以PE数据节大小永远是0x200的整数倍
当代码装入后，将按照内存数据标准存放，并以0x1000字节为基本的存储单位进行组织，不足和超过的情况类似上面。因此，内存中的节总是0x1000的整倍数。

|节(section)|相对虚拟偏移量RVA|文件偏移量|
|-|-|-|
|.text|	0x00001000|	0x0400|
|.rdata|	0x00007000|	0x6200|
|.data|	0x00009000|	0x7400|
|.rscr|	0x0002D000|	0x7800|

由于内存中数据节相对于装载基址的偏移量和文件中数据节的偏移量有上述差异，所以进行文件偏移到内存地址之间的换算时，还要看所转换的地址位于第几个节内:
```
.text  节偏移 = 0x1000-0x400 = 0xc00
.rdata 节偏移 = 0x7000-0x6200 = 0xE00
.data  节偏移 = 0x9000-0x7400 = 0x1C00
.rsrc  节偏移 = 0x2D000-0x7800 = 0x25800
```
文件偏移地址跟虚拟内存地址之间的换算关系可用下面的公式来计算。
> 文件偏移地址 = 虚拟内存地址(VA) - 装载基址(Image Base) - 节偏移​ = RVA - 节偏移