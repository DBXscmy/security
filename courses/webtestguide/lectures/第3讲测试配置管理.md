# 第三讲 测试配置管理

理解托管Web应用的服务器配置与应用安全测试本身同样重要。毕竟，一个应用链只与它的脆弱链一样强。应用平台是广泛的、可变的，但一些关键平台配置错误会令应用被攻陷。

## 测试网络/架构配置 Test Network Infrastructure Configuration

ID : WSTG-CONFIG-001

一个简单的配置错误就有可能引起整个系统的崩溃。为了维护应用程序本身的安全性，需要对Web服务器的基本设置进行安全测试，防止因配置错误引入风险。

检查的配置管理，至少包括下面的步骤：
- 确定构成基础架构的组成元素，了解它们的功能和相互关系，了解它们对安全性的影响情况；
- 对基础架构中的所有元素进行安全测试，确保它们不包含任何已知的漏洞；
- 对维护基础架构中各个元素的工具/软件进行安全测试，确保它们不引入任何风险；
- 对身份验证系统进行检查，确保它们满足应用程序的需求，不被外部用户操纵，能够防止非授权访问；
- 维护应用程序所需的已定义的端口列表，保证这些端口在安全控制中。

### 目标

- 明确Web基础架构中的组成部件/元素，了解它们对安全性的影响；
- 检查Web服务器基本配置的安全性；
- 检查所在网络的网络配置安全性。

### How to Test

#### 已知服务器漏洞

首先要保证的是OS server、 Web Server 和 Database 中不能有漏洞，至少要保证没有已知公开漏洞。

通常需要使用自动化测试工具进行较为全面的漏洞扫描测试；但自动化工具不能对复杂情景有效，对拒绝服务攻击漏洞也基本无效。

自动化测试工具往往依赖一些指纹，如Webserver的版本号，如果网站设计中已经规避了这一点，就会产生误报、漏报。

必须及时了解以下信息：
- 相关组件的公开漏洞信息及更新情况
- 非公开漏洞发布渠道信息
- 内、外部错误日志
- 相关组件的更新情况（供应商有时会默默地修复漏洞）

提供给安全测试人员软件使用的内部信息时，进行脆弱性复查是非常重要的，包括软件的版本和补丁都需要及时保持最新。

#### 管理工具

几乎所有的Web server、Database都需要管理工具进行维护。管理方式有：Web界面、文本文件、GUI工具等。

大多数情况下, 这些维护工具在处理Web server配置时，会采用下列方式进行文件传输：
- ftp
- webDAV
- 网络文件系统（NFS, CIFS）
- 其它机制

这些维护工具还将嵌入数据，包括用户数据和业务数据。

安全测试中需要在测试Web服务器的同时，对这些维护工具进行测试。重点是：
- 确定各个工具、接口、关联敏感数据的访问机制；
- 更改默认的用户名和密码。
- 公司外包服务器管理的情况（特别是管理界面对外网的访问控制）。

### 资源
下面是一些国外的安全信息交流平台：
- https://www.securityfocus.com/
- Bugtraq Mailing List is an electronic mailing list dedicated to issues about computer security. 
- https://exchange.xforce.ibmcloud.com/
- https://nvd.nist.gov/

## 测试应用程序平台配置 Test Application Platform Configuration

ID: WSTG-CONFIG-002

组成应用程序体系的每个元素/部件都需要被正确配置，这一点很重要，可以防止整个体系因一处脆弱性而被攻破。

配置审查和测试是创建和维护体系结构的关键任务。不少系统提供了默认的、通用的配置，但这些通用配置一般都不能满足组织的安全需求和目标，所以必须对他们进行检查和测试。

各组成部件和通用功能中不需要的文档、示例、测试页都不应该在部署后仍然存在于生产服务器上。

### 目标

测试各组成部件/元素的配置的安全性。

### How to Test

#### Black Box Testing
##### 检查已知的文件和目录 Sample and known files and directories

检查软件默认配置和默认目录的安全性。

许多默认 web server 中包含的示例配置和应用有公开已知的脆弱性。例如：
- CVE-1999-0449，Denial of Service in IIS when the Exair sample site had been installed.
-  CAN-2002-1744 (Directory traversal vulnerability in CodeBrws.asp in Microsoft IIS 5.0)
-  CAN-2002-1630 (Use of sendmail.jsp in Oracle 9iAS)
-  CAN-2003-1172 (Directory traversal in the view-source sample in Apache’s Cocoon).

使用包含已知文件和目录详细列表的 CGI scanner 可以帮助测试人员快速发现是否有被人熟知的目录和文件，然而唯一可以确定安全性的方法，还是全面的人工复查，检查web server 和 app的所有内容。

##### 注释复查

对于程序员来说，在开发大型的基于Web的应用程序时添加注释非常普遍。但是内嵌在HTML代码中的注释可能会揭示内部信息，攻击者会利用使用这些内部信息。

要防止一切不受控的代码注释泄漏。这需要对web应用和服务器上的所有文件进行注释审查。

##### 系统配置

CIS-CAT 为IT和安全专业人士提供了一个快速、详细的目标系统符合性评估。它基于CIS 基线。CIS还提供了一个推荐系统配置作为加固指南，包括 db、OS、web server 、visualization.

具体内容参考：
- https://www.cisecurity.org/cis-benchmarks/

#### 灰盒测试

##### 配置审查

Web服务器或应用程序服务器配置在保护站点内容方面起着重要作用，必须仔细检查它以发现常见的配置错误。显然，正确的配置取决于站点策略和服务器软件应提供的功能。但是在大多数情况下，应遵循配置准则（由软件供应商或外部机构提供）来确定服务器是否受到适当保护。

应考虑一些通用准则：
- 仅启用必要的服务器模块，可以减少复杂性、减少漏洞、减少攻击面，提高系统效率；
- 使用自定义页面处理错误（4xx or 5xx），而不是web server 或框架的默认错误页面；
- 防止任意错误引发的错误堆栈报告返回给最终用户；
- 确保服务器软件以OS的最小特权工作，防止因此应用软件而提权攻击，影响整个OS或其他应用；
- 确保服务器软件正确记录错误和合法访问。
- 确保将服务器配置为正确处理过载，能够防止“拒绝服务”攻击，确保已经正确调整服务器性能。
- 对非管理身份的用户和软件，切勿赋予对applicationHost.config，redirection.config和Administration.config的访问权限（“读取”或“写入”访问权限）。这包括Network Service，IIS_IUSRS，IUSR，或任何自由IIS应用程序池使用的身份。
- 切勿在网络上共享 applicationHost.config, redirection.config, and administration.config。使用共享配置时，最好将 applicationHost.config 导出到另一个位置。
- 牢记，默认情况下所有用户都可以读取.NET Framework machine.config和根web.config文件，请不要在这里面存放敏感信息。
- 加密仅由IIS工作进程读取的敏感信息，而不要让计算机上的其它用户读取。
- 不要授予对Web服务器用来访问共享服务器的身份的写访问权限applicationHost.config。该身份应仅具有读取权限。
- 使用单独的身份将applicationHost.config发布到共享。不要使用此身份在Web服务器上配置对共享配置的访问。
- 导出用于共享配置的加密密钥时，请使用强密码。
- 保持对包含共享配置和加密密钥的共享的受限访问。如果此共享遭到破坏，攻击者将能够为您的Web服务器读取和写入任何IIS配置，将流量从您的网站重定向到恶意源，并且在某些情况下，可以通过将任意代码加载到IIS worker中来控制所有Web服务器流程。
- 考虑使用防火墙规则和IPsec策略保护此共享，以仅允许成员Web服务器连接。

##### 日志

日志记录是应用程序体系结构安全性的重要资产，因为它可用于检测应用程序中的缺陷以及流氓用户的持续攻击。

日志通常由Web 服务器和其他服务器软件正确生成。能正确地将其操作记录到日志中的应用程序并不常见，一般的应用程序日志的主要目的是产生调试输出，以便程序员可以使用该调试输出来分析特定错误。能完整记录系统运行和访问的日志并不多。

在服务器和应用程序中，都应根据日志内容测试和分析几个问题：
- 日志中是否包含敏感信息？
- 日志是否存储在专用服务器中？
- 日志使用是否可以产生拒绝服务条件？
- 日志如何循环记录？日志是否保留了足够的时间？
- 如何复查日志？管理员可以使用这些复查来检测目标攻击吗？
- 如何保留日志备份？
- 被记录的数据在被记录之前是否经过验证（最小/最大长度，字符等）？

##### 日志中的敏感信息

服务器日志可能包含敏感信息（例如用户名、密码或银行帐户详细信息）。如果攻击者通过管理界面、已知的Web服务器漏洞或配置错误（例如，server-status基于Apache的HTTP服务器中的配置错误）获得日志，则攻击者可能会滥用此敏感信息。

对攻击者而言，事件日志中有价值的数据（信息泄漏或漏洞利用）包括：
- 调试信息
- 堆栈痕迹
- 用户名
- 系统组件名称
- 内部IP地址
- 低敏感的个人数据（例如与指定个人相关的电子邮件地址，邮政地址和电话号码）
- 业务资料

一些强制监管或数据敏感行业，可能存在这强制性数据保护法律或规章制度，将敏感数据存与日志或后台数据库中可能涉嫌违规、违法，所以务必全面审查系统日志和数据库记录。

更广范围的敏感信息包括但不限于：
- 应用程序源代码
- 会话标识值
- 访问令牌
- 敏感的个人数据和个人身份表单（PII）信息
- 认证密钥/密码
- 数据库连接字符串
- 加密密钥
- 银行账户、支付卡信息
- 较日志高级别更高级的安全级别信息
- 商业机密信息
- 与本行政区域适用法律、法规相违背的信息或处理
- 违背用户意愿的信息收集和存储。

##### 日志的存放位置

通常服务器会将记录的信息或错误生成本地日志，并将它存放在所允许的机器上。然而如果这台服务器被入侵，那么日志就可能被非法获取、修改或删除，以掩盖攻击者的目的、方法和行踪。很多自动化的攻击工具都包括一个log zapper，能够清除所有的日志。

明智的方法是将日志与Web 服务器分别存放在不同的机器上。此外，这种方法还有利于汇聚不同日志源的信息，方便进行日志分析。

##### 日志存储

日志的不恰当存储方式（如容量、位置等），可能会造成DoS攻击。任何拥有足够资源的攻击者都可能产生大量的请求，使日志记录激增，迅速占满存储空间或网络带宽。

Unix/Linux会将日志存放在/var、/opt、/usr/local目录中。重点是需要将日志存放在单独的分区，分区的大小要有限额，使日志不影响其它系统或应用。

要设置日志监视，一旦出现异常情况要予以应急响应。

##### 日志转储

很多系统在设计日志记录时，会将写操作设置为循环写入。此时要检查以下情况：
- 合规性：日志是否按照安全策略中定义的时间保存，并且不多也不少。
- 完整性：日志是否在发生转储时被压缩归档（这很方便，因为这意味着将为相同的可用磁盘空间存储更多日志）。
- 机密性：必须确保攻击者无法强迫日志旋转以隐藏其踪迹。
- 访问控制：循环日志文件的系统权限与日志文件本身的系统权限应相同（或更严格）。
  - 例如，Web服务器将需要写入其使用的日志，但实际上并不需要写入轮换日志，这意味着可以在轮换时更改文件的权限，以防止Web服务器进程修改它们。

##### 日志的访问控制

日志信息应对最终用户永不可见，甚至 Web 管理员也不应查看所有日志。必须有一套谨慎的日志访问控制策略。

##### 日志审查

为了分析Web服务器攻击，需要分析服务器的错误日志文件。审查应集中于：
- 40x（未找到）错误消息。来自相同来源的大量此类信息可能表明正在针对Web服务器使用CGI扫描程序工具。
- 50x（服务器错误）消息。这可能表明攻击者滥用了应用程序的某些意外失败的部分。例如，当SQL查询未正确构建并且在后端数据库上执行失败时，SQL注入攻击的第一阶段将产生这些错误消息。


日志统计信息或分析不应在生成日志的同一服务器中生成或存储。否则，攻击者可能会通过Web服务器漏洞或不正确的配置来获得对它们的访问权限，并检索日志文件本身所公开的类似信息。
### 参考

#### Apache
- Apache Security, by Ivan Ristic, O’reilly, March 2005.
- Apache Security Secrets: Revealed (Again), Mark Cox, November 2003
- Apache Security Secrets: Revealed, ApacheCon 2002, Las Vegas, Mark J Cox, October 2002
- Performance Tuning

#### Lotus Domino

- Lotus Security Handbook, William Tworek et al., April 2004, available in the IBM Redbooks collection 
- Lotus Domino Security, an X-force white-paper, Internet Security Systems, December 2002
- Hackproofing Lotus Domino Web Server, David Litchfield, October 2001

#### Microsoft IIS

- Security Best Practices for IIS 8
- CIS Microsoft IIS Benchmarks
- Securing Your Web Server (Patterns and Practices), Microsoft Corporation, January 2004
- IIS Security and Programming Countermeasures, by Jason Coombs 
- From Blueprint to Fortress: A Guide to Securing IIS 5.0, by John Davis, Microsoft Corporation, June 2001 
- Secure Internet Information Services 5 Checklist, by Michael Howard, Microsoft Corporation, June 2000

#### Red Hat’s (formerly Netscape’s) iPlanet

- Guide to the Secure Configuration and Administration of iPlanet Web Server, Enterprise Edition 4.1, by James M Hayes, The Network Applications Team of the Systems and Network Attack Center (SNAC), NSA, January 2001

#### WebSphere

- IBM WebSphere V5.0 Security, WebSphere Handbook Series, by Peter Kovari et al., IBM, December 2002.
- IBM WebSphere V4.0 Advanced Edition Security, by Peter Kovari et al., IBM, March 2002.


#### General

- [Logging Cheat Sheet, OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)
- [SP 800-92 Guide to Computer Security Log Management, NIST](https://csrc.nist.gov/publications/detail/sp/800-92/final)
- [PCI DSS v3.1 Requirement 10 and PA-DSS v2.0 Requirement 4, PCI Security Standards Council](https://www.pcisecuritystandards.org/document_library)


#### Generic:

- [CERT Security Improvement Modules: Securing Public Web Servers](https://resources.sei.cmu.edu/asset_files/SecurityImprovementModule/2000_006_001_13637.pdf)
- [How To: Use IISLockdown.exe](https://support.microsoft.com/en-us/help/325864/how-to-install-and-use-the-iis-lockdown-wizard)

## 测试文件扩展名处理敏感信息 Test File Extensions Handling for Sensitive Information

文件扩展名常见于各种文件系统。服务器可以通过识别扩展名，方便的选择使用何种技术、编码、语言或工具访问文件。尽管令每个文件都有正确的扩展名，这与RFC和Web标准一致，但是这也为攻击者提供了当前服务器所用基础技术的有用信息，并且很容易确定使用何种技术进行攻击，甚至可能因web服务器的错误配置泄露访问凭据的机密信息。

在网页中上传文件时，通常会有扩展名检查机制，这也可能会暴露后台处理的细节。此外，如果攻击者上传异构文件，可能会导致错误，引发错误信息泄露或缓冲区溢出。

### How to Test

#### 强制浏览

提交包含多种文件扩展名的 http/https请求，验证服务器如何响应，或这些请求如何被处理。

验证应当基于每个Web目录，特别是验证那些允许执行脚本的目录。Web服务器目录可以使用脆弱性扫描工具进行发现，此外，如果能设立该web站点结构的镜像将使测试者能够重建web目录树。

如果web应用架构使用了负载均衡，那么要访问所有的后端 web 服务器，但这可能并太容易。在具有冗余组件的基础架构中，各个Web或应用程序服务器的配置可能会略有不同。如果Web架构采用异构技术，则可能会发生这种情况。

例如：测试人员发现了一个名为 connection.inc的文件，尝试访问它时返回了这样的内容：
```
<?
 mysql_connect(“127.0.0.1”, “root”, “”)
 or die(“Could not connect”);
?>
```

测试人员认为这是后台使用mysql的证据，而且使用了弱口令进行访问。

下面这些文件扩展名，绝不应该被web服务器返回，因为它们关联的文件可能包含这敏感信息或不应该由服务器提供：
- .asa 
  - 是ASP的一个全局应用文件。主要是定义Session对象和Application对象，以及相应的事件。
- .inc
  - 包含文件，可用于包含部分html代码
- .config 或 .conf
  - 配置文件

下面这些文件扩展名，当用户访问时会在浏览器端显示下载或直接显示。因此这些文件必须被检查是否有必要服务，有没有包含敏感信息：
- .zip, .tar, .gz, .tgz, .rar, ...: (Compressed) archive files
- .java: No reason to provide access to Java source files
- .txt: Text files
- .pdf: PDF documents
- .doc, .rtf, .xls, .ppt, ...: Office documents
- .bak, .old and other extensions indicative of backup files (for example: ~ for Emacs backup files)

上面的列表仅仅列了一些常见的文件扩展名，而现实中的文件扩展名何止万千，我们可以参考 https://filext.com 来了解更多的文件扩展名。

为识别有扩展名的文件，有一组技术可被应用。 这些技术可以包含脆弱性扫描、爬虫和监控工具、手动检查应用、查询搜索引擎等功能。

此外可以参考 [Testing for Old, Backup and Unreference Files](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/04-Review_Old_Backup_and_Unreferenced_Files_for_Sensitive_Information.md) 来处理系统中被遗忘文件的安全性。

#### 文件上传

Windows 8.3旧式文件处理( Windows 8.3 legacy file handling )有时可以用来破坏文件上传过滤器

用法示例：
```
file.phtml gets processed as PHP code

FILE~1.PHT is served, but not processed by the PHP ISAPI handler

shell.phPWND can be uploaded

SHELL~1.PHP will be expanded and returned by the OS shell, then processed by the PHP ISAPI handler
```

> TODO：不清楚这节的意义。

#### 灰盒测试

对文件扩展名进行白盒测试，相当于检查Web服务器和其它应用程序服务的配置，验证它们如何处理不同的文件。

如果web应用依赖一个负载均衡、异构架构，那要考虑在不同的服务器上是否有不同的行为和结果，是否会引入脆弱性。

### Tools

- web 镜像工具
- 漏洞扫描器  Nessus and Nikto，可发现web目录和文件，用于判断web目录配置和如何对不同文件进行服务。
- 下载工具 wget，curl

## 复查老文件、备份文件和未被引用文件中的敏感信息 Review Old, Backup and Unreferenced Files for Sensitive Information

ID : WSTG-CONFIG-004



