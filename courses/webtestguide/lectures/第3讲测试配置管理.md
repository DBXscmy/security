# 第三讲 测试配置管理

理解托管Web应用的服务器配置与应用安全测试本身同样重要。毕竟，一个应用链只与它的脆弱链一样强。应用平台是广泛的、可变的，但一些关键平台配置错误会令应用被攻陷。

## 测试网络/架构配置 Test Network Infrastructure Configuration

ID : WSTG-CONFIG-001

一个简单的配置错误就有可能引起整个系统的崩溃。为了维护应用程序本身的安全性，需要对Web服务器的基本设置进行安全测试，防止因配置错误引入风险。

检查的配置管理，至少包括下面的步骤：
- 确定构成基础架构的组成元素，了解它们的功能和相互关系，了解它们对安全性的影响情况；
- 对基础架构中的所有元素进行安全测试，确保它们不包含任何已知的漏洞；
- 对维护基础架构中各个元素的工具/软件进行安全测试，确保它们不引入任何风险；
- 对身份验证系统进行检查，确保它们满足应用程序的需求，不被外部用户操纵，能够防止非授权访问；
- 维护应用程序所需的已定义的端口列表，保证这些端口在安全控制中。

### 目标

- 明确Web基础架构中的组成部件/元素，了解它们对安全性的影响；
- 检查Web服务器基本配置的安全性；
- 检查所在网络的网络配置安全性。

### How to Test

#### 已知服务器漏洞

首先要保证的是OS server、 Web Server 和 Database 中不能有漏洞，至少要保证没有已知公开漏洞。

通常需要使用自动化测试工具进行较为全面的漏洞扫描测试；但自动化工具不能对复杂情景有效，对拒绝服务攻击漏洞也基本无效。

自动化测试工具往往依赖一些指纹，如Webserver的版本号，如果网站设计中已经规避了这一点，就会产生误报、漏报。

必须及时了解以下信息：
- 相关组件的公开漏洞信息及更新情况
- 非公开漏洞发布渠道信息
- 内、外部错误日志
- 相关组件的更新情况（供应商有时会默默地修复漏洞）

提供给安全测试人员软件使用的内部信息时，进行脆弱性复查是非常重要的，包括软件的版本和补丁都需要及时保持最新。

#### 管理工具

几乎所有的Web server、Database都需要管理工具进行维护。管理方式有：Web界面、文本文件、GUI工具等。

大多数情况下, 这些维护工具在处理Web server配置时，会采用下列方式进行文件传输：
- ftp
- webDAV
- 网络文件系统（NFS, CIFS）
- 其它机制

这些维护工具还将嵌入数据，包括用户数据和业务数据。

安全测试中需要在测试Web服务器的同时，对这些维护工具进行测试。重点是：
- 确定各个工具、接口、关联敏感数据的访问机制；
- 更改默认的用户名和密码。
- 公司外包服务器管理的情况（特别是管理界面对外网的访问控制）。

### 资源
下面是一些国外的安全信息交流平台：
- https://www.securityfocus.com/
- Bugtraq Mailing List is an electronic mailing list dedicated to issues about computer security. 
- https://exchange.xforce.ibmcloud.com/
- https://nvd.nist.gov/

## 测试应用程序平台配置 Test Application Platform Configuration

ID: WSTG-CONFIG-002

组成应用程序体系的每个元素/部件都需要被正确配置，这一点很重要，可以防止整个体系因一处脆弱性而被攻破。

配置审查和测试是创建和维护体系结构的关键任务。不少系统提供了默认的、通用的配置，但这些通用配置一般都不能满足组织的安全需求和目标，所以必须对他们进行检查和测试。

各组成部件和通用功能中不需要的文档、示例、测试页都不应该在部署后仍然存在于生产服务器上。

### 目标

测试各组成部件/元素的配置的安全性。

### How to Test

#### Black Box Testing
##### 检查已知的文件和目录 Sample and known files and directories

检查软件默认配置和默认目录的安全性。

许多默认 web server 中包含的示例配置和应用有公开已知的脆弱性。例如：
- CVE-1999-0449，Denial of Service in IIS when the Exair sample site had been installed.
-  CAN-2002-1744 (Directory traversal vulnerability in CodeBrws.asp in Microsoft IIS 5.0)
-  CAN-2002-1630 (Use of sendmail.jsp in Oracle 9iAS)
-  CAN-2003-1172 (Directory traversal in the view-source sample in Apache’s Cocoon).

使用包含已知文件和目录详细列表的 CGI scanner 可以帮助测试人员快速发现是否有被人熟知的目录和文件，然而唯一可以确定安全性的方法，还是全面的人工复查，检查web server 和 app的所有内容。

##### 注释复查

对于程序员来说，在开发大型的基于Web的应用程序时添加注释非常普遍。但是内嵌在HTML代码中的注释可能会揭示内部信息，攻击者会利用使用这些内部信息。

要防止一切不受控的代码注释泄漏。这需要对web应用和服务器上的所有文件进行注释审查。

##### 系统配置

CIS-CAT 为IT和安全专业人士提供了一个快速、详细的目标系统符合性评估。它基于CIS 基线。CIS还提供了一个推荐系统配置作为加固指南，包括 db、OS、web server 、visualization.

具体内容参考：
- https://www.cisecurity.org/cis-benchmarks/

#### 灰盒测试

##### 配置审查

Web服务器或应用程序服务器配置在保护站点内容方面起着重要作用，必须仔细检查它以发现常见的配置错误。显然，正确的配置取决于站点策略和服务器软件应提供的功能。但是在大多数情况下，应遵循配置准则（由软件供应商或外部机构提供）来确定服务器是否受到适当保护。

应考虑一些通用准则：
- 仅启用必要的服务器模块，可以减少复杂性、减少漏洞、减少攻击面，提高系统效率；
- 使用自定义页面处理错误（4xx or 5xx），而不是web server 或框架的默认错误页面；
- 防止任意错误引发的错误堆栈报告返回给最终用户；
- 确保服务器软件以OS的最小特权工作，防止因此应用软件而提权攻击，影响整个OS或其他应用；
- 确保服务器软件正确记录合法访问和错误。
- 确保将服务器配置为正确处理过载，能够防止“拒绝服务”攻击，确保已经正确调整服务器性能。
- 对非管理身份的用户和软件，切勿赋予对applicationHost.config，redirection.config和Administration.config的访问权限（“读取”或“写入”访问权限）。这包括Network Service，IIS_IUSRS，IUSR，或任何自由IIS应用程序池使用的身份。
- 切勿在网络上共享 applicationHost.config, redirection.config, and administration.config。使用共享配置时，最好将 applicationHost.config 导出到另一个位置。
- 牢记，默认情况下所有用户都可以读取.NET Framework machine.config和根web.config文件，请不要在这里面存放敏感信息。
- 加密仅由IIS工作进程读取的敏感信息，而不要让计算机上的其它用户读取。
- 不要授予对Web服务器用来访问共享服务器的身份的写访问权限applicationHost.config。该身份应仅具有读取权限。
- 使用单独的身份将applicationHost.config发布到共享。不要使用此身份在Web服务器上配置对共享配置的访问。
- 导出用于共享配置的加密密钥时，请使用强密码。
- 保持对包含共享配置和加密密钥的共享的受限访问。如果此共享遭到破坏，攻击者将能够为您的Web服务器读取和写入任何IIS配置，将流量从您的网站重定向到恶意源，并且在某些情况下，可以通过将任意代码加载到IIS worker中来控制所有Web服务器流程。
- 考虑使用防火墙规则和IPsec策略保护此共享，以仅允许成员Web服务器连接。

##### 日志

日志记录是应用程序体系结构安全性的重要资产，因为它可用于检测应用程序中的缺陷（用户不断尝试检索不存在的文件）以及流氓用户的持续攻击。日志通常由Web和其他服务器软件正确生成。找到正确地将其操作记录到日志中的应用程序并不常见，并且当它们这样做时，应用程序日志的主要目的是产生调试输出，程序员可以使用该调试输出来分析特定错误。

在服务器和应用程序中，都应根据日志内容测试和分析几个问题：
- 日志中是否包含敏感信息？
- 日志是否存储在专用服务器中？
- 日志使用是否可以产生拒绝服务条件？
- 它们如何旋转？日志是否保留了足够的时间？
- 如何复查日志？管理员可以使用这些复查来检测目标攻击吗？
- 如何保留日志备份？
- 被记录的数据在被记录之前是否经过验证（最小/最大长度，字符等）？

##### 日志中的敏感信息
某些应用程序可能使用GET请求来转发将在服务器日志中看到的表单数据。这意味着服务器日志可能包含敏感信息（例如用户名（如密码）或银行帐户详细信息）。如果攻击者通过管理界面或已知的Web服务器漏洞或配置错误（例如，server-status基于Apache的HTTP服务器中众所周知的配置错误）获得日志，则攻击者可能会滥用此敏感信息。

事件日志通常包含对攻击者有用的数据（信息泄漏）或可以直接用于漏洞利用中的数据：
- 调试信息
- 堆栈痕迹
- 用户名
- 系统组件名称
- 内部IP地址
- 不太敏感的个人数据（例如与指定个人相关的电子邮件地址，邮政地址和电话号码）
- 业务资料
